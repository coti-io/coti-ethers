# coti-ethers

Inspired by the [zksync-ethers](https://github.com/zksync-sdk/zksync-ethers/blob/main/README.md) package.

In order to provide easy access to all the features of COTI, the coti-ethers JavaScript SDK was created, which is made in a way that has an interface very similar to those of ethers. In fact, ethers is a peer dependency of our library and all of the objects exported by coti-ethers ( e.g. Wallet, BrowserProvider, etc.) inherit from the corresponding ethers objects and extend their functionality where needed.

While most of the existing SDKs should work out of the box, using unique COTI features like encrypting transaction inputs, requires executing the onboarding procedure and encrypting using the defined protocol.

The library is made in such a way that after replacing ethers with coti-ethers most client apps will work out of box.

## Examples

## BrowserProvider.ts

### Constructor

`constructor(ethereum: Eip1193Provider, network?: Networkish, _options?: BrowserProviderOptions)`

- **Parameters:**
    - ethereum: Eip1193Provider: The Ethereum provider instance that complies with the EIP-1193 specification (e.g., MetaMask).
    - network?: Networkish: Optionally force a specific network (mainnet, testnet, etc.).
    - _options?: BrowserProviderOptions: Additional configuration options for the provider.

### Methods

#### 1. `async getSigner(address?: number | string, userOnboardInfo?: OnboardInfo): Promise<JsonRpcSigner>`

- **Parameters:**
    - address?: number | string: The index or address of the account for which the signer is requested.
    - userOnboardInfo?: OnboardInfo: Optional onboarding information passed as an object, which might include specific user-related data such as the user AES key, or the tx hash of the tx containing the users onboarding procedure and the RSA key used to encrypt their AES key.

- **Returns:**
    - A Promise resolving to a JsonRpcSigner object, which can be used to sign transactions or interact with the blockchain on behalf of the account specified by address.

## JsonRpcApiProvider.ts

### Constructor

`constructor(network?: Networkish, options?: JsonRpcApiProviderOptions)`

- **Parameters:**
    - network?: Networkish: Optionally force a specific network (mainnet, testnet, etc.).
    - userOnboardInfo?: OnboardInfo: Optional onboarding information passed as an object, which might include specific user-related data such as the user AES key, or the tx hash of the tx containing the users onboarding procedure and the RSA key used to encrypt their AES key.

### Methods

#### 1. `async getSigner(address?: number | string, userOnboardInfo?: OnboardInfo): Promise<JsonRpcSigner>`

- **Parameters:**
    - address?: number | string: The index or address of the account for which the signer is requested.
    - userOnboardInfo?: OnboardInfo: Optional onboarding information passed as an object, which might include specific user-related data such as the user AES key, or the tx hash of the tx containing the users onboarding procedure and the RSA key used to encrypt their AES key.

- **Returns:**
    - A Promise resolving to a JsonRpcSigner object, which can be used to sign transactions or interact with the blockchain on behalf of the account specified by address.

## JsonRpcSigner.ts

### Constructor

`constructor(provider: JsonRpcApiProvider, address: string, userOnboardInfo?: OnboardInfo)`

- **Parameters:**
    - provider: JsonRpcApiProvider: The JSON-RPC provider used to interact with the blockchain.
    - address: string: The COTI account address associated with this signer.
    - userOnboardInfo?: OnboardInfo: Optional onboarding information passed as an object, which might include specific user-related data such as the user AES key, or the tx hash of the tx containing the users onboarding procedure and the RSA key used to encrypt their AES key.

### Methods

#### 1. `async encryptValue(plaintextValue: bigint | number | string, contractAddress: string, functionSelector: string): Promise<any>`

- **Parameters:**
    - plaintextValue: bigint | number | string: The value to be encrypted, which can be one of the following types: bigint, number, string.
    - contractAddress: string: The address of the smart contract to which the encrypted data will be sent.
    - functionSelector: string: The 4-byte function selector that identifies the specific smart contract function which will process the encrypted data.

- **Returns:**
    - A Promise that resolves to the encrypted result, which is generated by one of the internal encryption methods (#buildInputText or #buildStringInputText), depending on the type of the plaintextValue.

#### 2. `async decryptValue(ciphertext: bigint | Array<bigint>): Promise<any>`

- **Parameters:**
    - ciphertext: bigint | Array<bigint>: The encrypted data to be decrypted, which can be: bigint, Array<bigint>

- **Returns:**
    - A Promise that resolves to the decrypted data, which is either of type bigint or string depending on the type of the input

#### 3. `async generateOrRecoverAes(onboardContractAddress: string = DEVNET_ONBOARD_CONTRACT_ADDRESS): Promise<void>`

- **Parameters:**
    - onboardContractAddress?: string: Optional address of the onboarding contract on the COTI network. Defaults to DEVNET_ONBOARD_CONTRACT_ADDRESS

- **Returns:**
    - A Promise that resolves to void. This function does not return any value, but it updates the user's onboard information (_userOnboardInfo) and AES key if necessary.

## account.ts

### 1.`printAccountDetails(provider: Provider, address: string)`

Prints the account details of the default account in the Web3 instance.

**Parameters:**

- `provider`: An instance of ethers provider.
- `address`: an Ethereum EOA account.

### 2. `getAccountBalance(address: string, provider: Provider)`

Retrieves the native balance of an address in wei.

**Parameters:**

- `provider`: An instance of ethers provider.
- `address`: The address to check the balance of (default is the default account).

**Returns:**

- `result`: The address balance in wei.

### 3. `validateAddress(address: string)`

Validates and returns the checksum address for a given address.

**Parameters:**

- `address`: The address to be validated.

**Returns:**

- `result`: A map with `valid` (boolean) and `safe` (checksum address).

### 4. `getNonce(provider: Provider, address: string)`

Retrieves the nonce for the default account.

**Parameters:**

- `provider`: An instance of ethers provider.
- `address`: The address to check the balance of (default is the default account).

**Returns:**

- `nonce`: The nonce for the default account.

### 5. `addressValid(address: string):`

Checks if an address is valid.

**Parameters:**

- `address`: The address to be validated.

**Returns:**

- `valid`: Boolean indicating if the address is valid.

### 6. `getNativeBalance(address: string, provider: Provider)`

Retrieves the native balance of an address in Ether.

**Parameters:**

- `provider`: An instance of ethers provider.
- `address`: The address to check the balance of (default is the default account).

**Returns:**

- `result`: The address balance in Ether.

### 7. `getEoa(accountPrivateKey: string)`

Generates an externally owned account (EOA) from a private key.

**Parameters:**

- `accountPrivateKey`: The private key of the account.

**Returns:**

- `eoa`: The generated EOA.

### 8. `transferNative(provider: Provider, wallet: Wallet, recipientAddress: string, amountToTransferInWei: BigInt, nativeGasUnit: number)`

Transfers native cryptocurrency from the default account to a recipient address.

**Parameters:**

- `provider`: An instance of ethers provider.
- `wallet`: an ether wallet to sign the ether transaction.
- `recipientAddress`: The address of the recipient.
- `amountToTransferInWei`: The amount of Ether to transfer.
- `nativeGasUnit`: The gas limit for the transaction.

**Returns:**

- `tx_receipt`: The transaction receipt.

## network.ts

### 1.`getDefaultProvider(cotiNetwork: CotiNetwork)`

**Parameters:**

- `cotiNetwork`: CotiNetwork (Devnet): The name of the network to connect to

**Returns**

- An instance of JsonRpcProvider for the appropriate network

### 2.`printNetworkDetails(provider: Provider)`

Prints the network details of the provider instance.

**Parameters:**

- `provider`: An instance of ethers provider.

### 3. `getLatestBlock(provider: Provider)`

Retrieves the latest block from the COTI network.

**Parameters:**

- `provider`: An instance of ethers provider.

**Returns:**

- `latestBlock`: The latest block object.

### 4.`isProviderConnected(provider: Provider)`

Checks if the Web3 instance is connected.

**Parameters:**

- `provider`: An instance of ethers provider.

**Returns:**

- `connected`: Boolean indicating if Web3 is connected.

## onboard.ts

### 1.`getAccountOnboardContract(contractAddress: string, wallet?: Signer)`

**Parameters:**

- `contractAddress`: string: The address of the onboard contract
- `wallet?`: Signer: The signer object to connect to the contract

**Returns**

- An instance of the AccountOnboard contract

### 2. `onboard(defaultOnboardContractAddress: string, signer: BaseWallet | JsonRpcSigner): Promise<{ aesKey: string, rsaKey: { publicKey: string, privateKey: string }, txHash: string }>`

The onboard function is an asynchronous method responsible for onboarding a user to the COTI blockchain network. During the onboarding process, the function generates an RSA key pair, signs the public key, and interacts with the COTI onboarding smart contract to register the user. Once onboarded, the userâ€™s AES key is securely transmitted and decrypted using their RSA private key.

**Parameters:**

- `defaultOnboardContractAddress`: string: The address of the default onboarding contract deployed on the COTI blockchain. This is used to interact with the onboarding contract for registering new users.
- `signer`: BaseWallet | JsonRpcSigner: The user's signing mechanism

**Returns:**

- A Promise that resolves to an object containing the following properties:
    - `aesKey`: string: The user's AES encryption key, which is decrypted from the encrypted data returned by the onboarding contract.
    - `rsaKey`: { publicKey: string, privateKey: string }: The RSA key pair generated for the user during the onboarding process. This includes:
        - `publicKey`: The public part of the RSA key used to encrypt data sent to the user.
        - `privateKey`: The private part of the RSA key, used to decrypt data.
    - `txHash`: string: The transaction hash for the onboarding transaction, which can be used for future reference or verification.

### 3. `recoverAesFromTx(txHash: string, rsaKey: RsaKeyPair, defaultOnboardContractAddress: string, provider: Provider | null): Promise<string>`

Recovers the users AES key from the provided transaction

**Parameters:**

- `txHash`: string: The transaction hash for the onboarding transaction. This is used to fetch the corresponding transaction receipt from the blockchain.
- `rsaKey`: RsaKeyPair: The RSA key pair, which includes the private key needed to decrypt the AES key. It is an object with the following structure:
    - `publicKey`: string: The RSA public key.
    - `privateKey`: string: The RSA private key.
- `defaultOnboardContractAddress`: string: The address of the onboarding contract, which is needed to interact with the contract and decode the logs from the transaction receipt.
- `provider`: Provider | null: The provider used to fetch the transaction receipt. If null, the function will use the default provider for the COTI Devnet.

**Returns:**

- A Promise that resolves to the decrypted AES key as a string. This AES key is extracted from the transaction logs and decrypted using the provided RSA private key.

## transaction.ts

### 1. `validateGasEstimation(provider: Provider, tx: TransactionRequest)`

Validates the gas estimation for a transaction.

**Parameters:**

- `provider`: An instance of ethers provider.
- `tx`: The transaction object.

### 2. isGasEstimationValid(provider: Provider, tx: TransactionRequest)`

Checks if the provided gas units are sufficient for the transaction.

**Parameters:**

- `provider`: An instance of ethers provider.
- `tx`: The transaction object.

**Returns:**

- `valid`: Boolean indicating if the gas units are sufficient.
- `gas_estimate`: The estimated gas units.

## Wallet.ts

### Constructor

`constructor(privateKey: string | SigningKey, provider?: Provider | null, userOnboardInfo?: OnboardInfo)`

- **Parameters:**
    - privateKey: string | SigningKey: The private key to use for signing transactions
    - provider: JsonRpcApiProvider: The JSON-RPC provider used to interact with the blockchain.
    - userOnboardInfo?: OnboardInfo: Optional onboarding information passed as an object, which might include specific user-related data such as the user AES key, or the tx hash of the tx containing the users onboarding procedure and the RSA key used to encrypt their AES key.

### Methods

#### 1. `async encryptValue(plaintextValue: bigint | number | string, contractAddress: string, functionSelector: string): Promise<any>`

- **Parameters:**
    - plaintextValue: bigint | number | string: The value to be encrypted, which can be one of the following types: bigint, number, string.
    - contractAddress: string: The address of the smart contract to which the encrypted data will be sent.
    - functionSelector: string: The 4-byte function selector that identifies the specific smart contract function which will process the encrypted data.

- **Returns:**
    - A Promise that resolves to the encrypted result, which is generated by one of the internal encryption methods (#buildInputText or #buildStringInputText), depending on the type of the plaintextValue.

#### 2. `async decryptValue(ciphertext: bigint | Array<bigint>): Promise<any>`

- **Parameters:**
    - ciphertext: bigint | Array<bigint>: The encrypted data to be decrypted, which can be: bigint, Array<bigint>

- **Returns:**
    - A Promise that resolves to the decrypted data, which is either of type bigint or string depending on the type of the input

#### 3. `async generateOrRecoverAes(onboardContractAddress: string = DEVNET_ONBOARD_CONTRACT_ADDRESS): Promise<void>`

- **Parameters:**
    - onboardContractAddress?: string: Optional address of the onboarding contract on the COTI network. Defaults to DEVNET_ONBOARD_CONTRACT_ADDRESS

- **Returns:**
    - A Promise that resolves to void. This function does not return any value, but it updates the user's onboard information (_userOnboardInfo) and AES key if necessary.